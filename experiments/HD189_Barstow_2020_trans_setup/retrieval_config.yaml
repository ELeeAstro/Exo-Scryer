data:

  obs: ../../obs_data/HD189733b_transmission_Sing2016.txt
  stellar: None
  janaf: ../../JANAF_data/

physics:

  nlay: 99

  vert_Tp: Barstow
  vert_alt: variable_g
  vert_chem: constant_vmr
  vert_mu: dynamic

  opac_line: lbl
  opac_ray: None
  opac_cia: None
  opac_cloud: powerlaw_cloud

  rt_scheme: transit_1d
  contri_func: True

opac:

  wl_master: wl_dnu_1.txt
  #wl_master: wl_petitradtrans_R1000.txt
  #wl_master: wl_taurex_R15000.txt
  full_grid: True
  ck: False
  ck_mix: RORR

  line:
    - {species: H2O, path: ../../opac_data/lbl/H2O_dnu_1.npz}
    # - {species: Na, path: ../../opac_data/lbl/Na_dnu_1.npz}  
    # - {species: K, path: ../../opac_data/lbl/K_dnu_1.npz}
       #- {species: H2O, path: ../../opac_data/ck/1H2-16O__POKAZATEL__R1000_0.3-50mu.ktable.petitRADTRANS.h5}
       #- {species: Na, path: ../../opac_data/ck/23Na__Kurucz-Na.R1000_0.3-50mu.ktable.petitRADTRANS.h5}
       #- {species: K, path: ../../opac_data/ck/39K__Kurucz-K.R1000_0.3-50mu.ktable.petitRADTRANS.h5}
      #- {species: H2O, path: ../opac_data/lbl/1H2-16O__POKAZATEL__R15000_0.3-50mu.xsec.TauREx.h5}
      #- {species: Na, path: ../opac_data/lbl/23Na__Kurucz-Na.R15000_0.3-50mu.xsec.TauREx.h5}
      #- {species: K, path: ../opac_data/lbl/39K__Kurucz-K.R15000_0.3-50mu.xsec.TauREx.h5}        

  ray: None
    #- {species: H2}
    #- {species: He}
  cia: None
    #- {species: H2-H2, path: ../../opac_data/cia/H2-H2_2011.npz}
    #- {species: H2-He, path: ../../opac_data/cia/H2-He_2011.npz}
  cloud: None

params:


  - { name: R_s,   dist: delta,   value: 0.776484, transform: identity, init: 0.776484}
  - { name: p_bot, dist: delta,   value: 10.0,  transform: identity, init: 10.0 }
  - { name: p_top, dist: delta,   value: 1e-5, transform: identity, init: 1e-5}
    #- { name: M_p, dist: delta,   value: 0.69, transform: identity, init: 0.69}
    #- { name: log_10_pref, dist: delta,   value: 1.0, transform: identity, init: 1.0}
    #- { name: log_10_p_ref, dist: uniform, low: -6,   high: 1.0,  transform: logit, init: 1}    

  - { name: log_10_g, dist: uniform, low: 2.9 , high: 3.4,  transform: logit, init: 3.0}
  - { name: R_p, dist: uniform, low: 0.9,   high: 1.3,  transform: logit, init: 1.0}
  - { name: T_strat, dist: uniform, low: 100.0,   high: 3000.0, transform: logit, init: 1500.0 }
  
  - { name: log_10_f_H2O, dist: uniform, low: -8,   high: -2,  transform: logit, init: -4}
  #- { name: log_10_f_Na, dist: uniform, low: -9,   high: -3,  transform: logit, init: -6}
  #- { name: log_10_f_K, dist: uniform, low: -9,   high: -3,  transform: logit, init: -6}

  # - { name: f_cloud, dist: uniform, low: 0.0,   high: 1.0, transform: logit, init: 0.5}

  - { name: log_10_k_cld_grey, dist: uniform, low: -6.0, high: 6.0, transform: logit, init: -5.0}
  - { name: log_10_k_cld_Ray, dist: uniform, low: -6.0, high: 6.0, transform: logit, init: -3.0}
  - { name: alpha_cld, dist: uniform, low: 0.0, high: 6.0, transform: logit, init: 4.0}
  - { name: wl_ref_cld, dist: delta, value: 1.0, transform: identity, init: 1.0}


sampling:

  engine: jaxns

  nuts:
    backend: numpyro
    warmup: 100
    draws: 200
    seed: 42
    chains: 1

  jaxns:
    # ---- core NS config ----
    max_samples: 100000          # hard cap on nested-sampling iterations
    num_live_points: 100        # live points (posterior resolution)

    # Slice sampler hyperparameters
    s: 4                         # slices per dimension (default ~4)
    k: 0                         # phantom samples (0 = off, >0 for hard posteriors)
    c: null                       # parallel chains (null -> jaxns default, ~20*D)
    shell_fraction: 0.5          # fraction of shell explored per step (0<sf<=1)

    # Global behaviour flags
    difficult_model: false       # robust defaults for gnarly posteriors
    parameter_estimation: true   # tune for good posterior, not just evidence
    gradient_guided: false       # use gradients for proposals (only if stable)
    init_efficiency_threshold: 0.05  # >0: initial uniform sampling until eff>thr
    verbose: true               # print textual progress to CLI

    # ---- termination controls ----
    termination:
      ess: 10000                        # target effective sample size
      evidence_uncert: null            # stop when σ_logZ < 0.3
      dlogZ: 0.1                     # stop when remaining evidence small
      max_samples: 100000             # safety cap for samples
      max_num_likelihood_evaluations: null
      rtol: null
      atol: null

    # ---- posterior handling ----
    posterior_samples: 10000           # equal-weight posterior draws
    seed: 42                          # RNG seed for JAX

  blackjax_ns:
    num_live_points: 100
    num_inner_steps: 18
    num_delete: 50
    dlogz_stop: 0
    seed: 42

  pymultinest:
    n_live_points: 1000              # Number of live points
    evidence_tolerance: 0.5          # Evidence tolerance (dlogZ stopping criterion)
    sampling_efficiency: 0.8         # 0.8 for unimodal, 0.3 for multimodal
    multimodal: false                # Enable mode separation
    const_efficiency_mode: false     # Constant efficiency mode
    importance_nested_sampling: true # Importance nested sampling for posterior
    resume: false                    # Resume from previous run
    verbose: true                    # Print progress
    seed: -1                         # Random seed (-1 = time-based)
    max_modes: 100                   # Maximum number of modes

  dynesty:
    nlive: 100                      # Number of live points
    bound: multi                     # Bounding: multi, single, balls, cubes
    sample: auto                     # Sampling: auto, unif, rwalk, slice, rslice
    dlogz: 1.0                       # Evidence tolerance (stopping criterion)
    maxiter: null                    # Maximum iterations (null = no limit)
    maxcall: null                    # Maximum likelihood calls (null = no limit)
    bootstrap: 0                     # Bootstrap iterations
    enlarge: null                    # Bounding enlargement factor (null = auto)
    update_interval: null            # Update interval (null = auto)
    dynamic: false                   # Use dynamic nested sampling
    print_progress: true             # Show progress bar
    seed: 42                         # Random seed

runtime:
  platform: cpu           # cpu | gpu | cuda | metal
  cuda_visible_devices: 1 # GPU device ID (only used when platform=gpu)

  # CPU Threading Configuration
  # ---------------------------
  # threads: Number of CPU threads for JAX operations (forward model execution)
  # - Used by ALL samplers when platform=cpu
  # - Affects: Matrix operations, opacity calculations, radiative transfer
  # - Recommended: 4-8 threads (diminishing returns beyond 8)
  # - Sets: XLA intra_op_parallelism_threads
  threads: 1

  # Sampler-Specific Parallelization
  # ---------------------------------
  # Note: Different samplers use different parallelization strategies:
  #
  # NUTS (NumPyro/BlackJAX):
  #   - Use 'chains' parameter to run multiple chains in parallel
  #   - Each chain uses 'threads' for forward model evaluation
  #   - Total cores used: chains × threads (set accordingly!)
  #
  # Dynesty/PyMultiNest:
  #   - Sequential nested sampling (no built-in threading)
  #   - Each likelihood call uses 'threads' for forward model
  #   - Total cores used: threads
  #
  # JAXNS/BlackJAX NS:
  #   - Can batch likelihood evaluations internally (JAX vmap)
  #   - Each evaluation uses 'threads' for forward model
  #   - Total cores used: threads (JAX handles batching)
